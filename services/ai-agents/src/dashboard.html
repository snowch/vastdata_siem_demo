<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOC Agent Analysis Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding-top: 20px; /* Added padding to prevent overlap */
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            position: relative;
        }

        .debug-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.7;
            z-index: 10;
        }

        .debug-toggle:hover {
            opacity: 1;
            transform: scale(1.05);
        }

        .debug-mode {
            background: linear-gradient(45deg, #e74c3c, #c0392b) !important;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
            line-height: 1.2;
        }

        .header p {
            color: #5a6c7d;
            font-size: 1.1em;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #36d1dc, #5b86e5);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .input-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .log-counter {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
            line-height: 1.4;
            white-space: nowrap;
            overflow-x: auto;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .workflow-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .agent-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: all 0.3s ease;
            position: relative;
        }

        .agent-card.active {
            transform: scale(1.02);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
        }

        .agent-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .agent-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 200px;
        }

        .agent-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .triage-icon {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .context-icon {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        .analyst-icon {
            background: linear-gradient(45deg, #a8e6cf, #3d8b37);
        }

        .agent-details h3 {
            color: #2c3e50;
            font-size: 1.4em;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .agent-details p {
            color: #7f8c8d;
            font-size: 0.95em;
            line-height: 1.3;
        }

        .status-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 80px;
            text-align: center;
            flex-shrink: 0;
        }

        .status-pending {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }

        .status-active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            animation: pulse 2s infinite;
        }

        .status-complete {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            color: white;
        }

        .status-error {
            background: linear-gradient(45deg, #ff416c, #ff4757);
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .agent-content {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            min-height: 150px;
            position: relative;
        }

        .agent-output {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading-spinner {
            display: none;
            justify-content: center;
            align-items: center;
            height: 100px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e1e8ed;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e8ed;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: 600;
            color: #2c3e50;
            white-space: nowrap;
        }

        .findings-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .findings-panel h3 {
            color: #2c3e50;
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .priority-indicator {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-critical {
            background: linear-gradient(45deg, #ff416c, #ff4757);
            color: white;
        }

        .priority-high {
            background: linear-gradient(45deg, #ffa726, #fb8c00);
            color: white;
        }

        .priority-medium {
            background: linear-gradient(45deg, #42a5f5, #1e88e5);
            color: white;
        }

        .findings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .finding-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .finding-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .finding-card p {
            color: #5a6c7d;
            line-height: 1.5;
            font-size: 0.95em;
        }

        .debug-panel {
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            color: #ecf0f1;
            display: none;
        }

        .debug-panel h3 {
            color: #e74c3c;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .debug-log {
            background: #34495e;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #4a5f7a;
            line-height: 1.4;
        }

        .debug-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .debug-btn {
            padding: 6px 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .debug-btn:hover {
            background: #c0392b;
        }

        .error-message {
            background: linear-gradient(45deg, #ff416c, #ff4757);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Toast notifications */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 14px;
            font-weight: 500;
            max-width: 300px;
            animation: slideInRight 0.3s ease;
            color: white;
        }

        .toast.success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
        }

        .toast.error {
            background: linear-gradient(45deg, #ff416c, #ff4757);
        }

        .toast.warning {
            background: linear-gradient(45deg, #ffa726, #fb8c00);
        }

        .toast.info {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        @media (max-width: 768px) {
            body {
                padding-top: 10px;
            }

            .dashboard {
                padding: 15px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .controls {
                justify-content: center;
            }

            .agent-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .findings-grid {
                grid-template-columns: 1fr;
            }
            
            #toast-container {
                left: 20px;
                right: 20px;
            }

            .debug-toggle {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 15px;
            }

            .agent-info {
                min-width: auto;
            }

            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8em;
            }

            .agent-icon {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .agent-details h3 {
                font-size: 1.2em;
            }

            .controls {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <button class="debug-toggle" onclick="toggleDebugMode()" id="debugToggle">
                🔧 Debug Mode
            </button>
            <h1>🛡️ SOC Agent Analysis Dashboard</h1>
            <p>Multi-agent security log analysis with real-time workflow visualization</p>
            <div class="controls">
                <button class="btn btn-secondary" onclick="retrieveLogs()">
                    📥 Retrieve Logs
                </button>
                <button class="btn btn-primary" onclick="startAnalysis()" id="analyzeBtn">
                    🚀 Start Analysis
                </button>
                <button class="btn" onclick="clearResults()" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d); color: white;">
                    🧹 Clear Results
                </button>
            </div>
        </div>

        <div class="input-section">
            <h3>
                Security Logs Input
                <span class="log-counter" id="logCounter">0 events</span>
            </h3>
            <textarea id="logInput" placeholder="Retrieved security logs will appear here, or paste your own OCSF logs..."></textarea>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
            <div class="progress-text" id="progressText">Ready</div>
        </div>

        <div class="workflow-container">
            <!-- Triage Agent Card -->
            <div class="agent-card" id="triageCard">
                <div class="agent-header">
                    <div class="agent-info">
                        <div class="agent-icon triage-icon">🔍</div>
                        <div class="agent-details">
                            <h3>Triage Specialist</h3>
                            <p>Initial threat identification and prioritization</p>
                        </div>
                    </div>
                    <div class="status-badge status-pending" id="triageStatus">Pending</div>
                </div>
                <div class="agent-content">
                    <div class="loading-spinner" id="triageSpinner">
                        <div class="spinner"></div>
                    </div>
                    <div class="agent-output" id="triageOutput">Waiting for analysis to begin...</div>
                </div>
            </div>

            <!-- Context Agent Card -->
            <div class="agent-card" id="contextCard">
                <div class="agent-header">
                    <div class="agent-info">
                        <div class="agent-icon context-icon">🔎</div>
                        <div class="agent-details">
                            <h3>Context Research Agent</h3>
                            <p>Historical incident correlation and pattern matching</p>
                        </div>
                    </div>
                    <div class="status-badge status-pending" id="contextStatus">Pending</div>
                </div>
                <div class="agent-content">
                    <div class="loading-spinner" id="contextSpinner">
                        <div class="spinner"></div>
                    </div>
                    <div class="agent-output" id="contextOutput">Waiting for triage completion...</div>
                </div>
            </div>

            <!-- Senior Analyst Card -->
            <div class="agent-card" id="analystCard">
                <div class="agent-header">
                    <div class="agent-info">
                        <div class="agent-icon analyst-icon">👨‍💼</div>
                        <div class="agent-details">
                            <h3>Senior Analyst</h3>
                            <p>Deep analysis and actionable recommendations</p>
                        </div>
                    </div>
                    <div class="status-badge status-pending" id="analystStatus">Pending</div>
                </div>
                <div class="agent-content">
                    <div class="loading-spinner" id="analystSpinner">
                        <div class="spinner"></div>
                    </div>
                    <div class="agent-output" id="analystOutput">Waiting for context research...</div>
                </div>
            </div>
        </div>

        <!-- Debug Panel -->
        <div class="debug-panel" id="debugPanel">
            <h3>🔧 Debug Console</h3>
            <div class="debug-controls">
                <button class="debug-btn" onclick="clearDebugLog()">Clear Log</button>
                <button class="debug-btn" onclick="exportDebugLog()">Export Log</button>
                <button class="debug-btn" onclick="showNetworkStats()">Network Stats</button>
            </div>
            <div class="debug-log" id="debugLog">Debug mode enabled. Detailed logs will appear here...</div>
        </div>

        <!-- Findings Panel -->
        <div class="findings-panel" id="findingsPanel" style="display: none;">
            <h3>
                🎯 Analysis Results
                <span class="priority-indicator" id="priorityIndicator">Unknown</span>
            </h3>
            <div class="findings-grid" id="findingsContent">
                <!-- Findings will be populated here -->
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        let analysisInProgress = false;
        let eventSource = null;
        let debugMode = false;
        let debugMessages = [];
        let networkStats = { requests: 0, errors: 0, totalBytes: 0 };

        // Debug Mode Functions
        function toggleDebugMode() {
            debugMode = !debugMode;
            const toggle = document.getElementById('debugToggle');
            const panel = document.getElementById('debugPanel');
            
            if (debugMode) {
                toggle.textContent = '🔧 Debug ON';
                toggle.classList.add('debug-mode');
                panel.style.display = 'block';
                debugLog('Debug mode enabled');
                showStatus('Debug mode enabled - detailed logging active', 'info');
            } else {
                toggle.textContent = '🔧 Debug Mode';
                toggle.classList.remove('debug-mode');
                panel.style.display = 'none';
                showStatus('Debug mode disabled', 'info');
            }
        }

        function debugLog(message, level = 'INFO') {
            if (!debugMode) return;
            
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] [${level}] ${message}`;
            debugMessages.push(logEntry);
            
            const debugLogElement = document.getElementById('debugLog');
            debugLogElement.textContent = debugMessages.slice(-100).join('\n'); // Keep last 100 messages
            debugLogElement.scrollTop = debugLogElement.scrollHeight;
            
            console.log(logEntry);
        }

        function clearDebugLog() {
            debugMessages = [];
            document.getElementById('debugLog').textContent = 'Debug log cleared.';
        }

        function exportDebugLog() {
            const blob = new Blob([debugMessages.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `soc-debug-${new Date().toISOString().slice(0, 19)}.log`;
            a.click();
            URL.revokeObjectURL(url);
            debugLog('Debug log exported');
        }

        function showNetworkStats() {
            const stats = `Network Statistics:
Requests Made: ${networkStats.requests}
Errors: ${networkStats.errors}
Total Data: ${(networkStats.totalBytes / 1024).toFixed(2)} KB
Success Rate: ${((networkStats.requests - networkStats.errors) / networkStats.requests * 100).toFixed(1)}%`;
            
            debugLog(stats);
            showStatus('Network stats logged to debug console', 'info');
        }

        // Enhanced network request wrapper
        async function makeRequest(url, options = {}) {
            networkStats.requests++;
            debugLog(`Making request to: ${url}`);
            
            try {
                const response = await fetch(url, options);
                const responseSize = response.headers.get('content-length');
                if (responseSize) {
                    networkStats.totalBytes += parseInt(responseSize);
                }
                
                debugLog(`Request completed: ${response.status} ${response.statusText}`);
                return response;
            } catch (error) {
                networkStats.errors++;
                debugLog(`Request failed: ${error.message}`, 'ERROR');
                throw error;
            }
        }

        // Enhanced log counter
        function updateLogCounter(logData) {
            let eventCount = 0;
            try {
                if (typeof logData === 'string') {
                    // Handle single-line JSON format - count non-empty lines that start with {
                    const lines = logData.split('\n').filter(line => line.trim());
                    eventCount = lines.filter(line => {
                        const trimmed = line.trim();
                        return trimmed.startsWith('{') && trimmed.endsWith('}');
                    }).length;
                    
                    // Fallback: if no JSON objects found, count all non-empty lines
                    if (eventCount === 0 && lines.length > 0) {
                        eventCount = lines.length;
                    }
                } else if (Array.isArray(logData)) {
                    eventCount = logData.length;
                }
            } catch (e) {
                // If parsing fails, count lines as rough estimate
                eventCount = logData.split('\n').filter(line => line.trim()).length;
            }
            
            document.getElementById('logCounter').textContent = `${eventCount} events`;
            debugLog(`Log counter updated: ${eventCount} events`);
        }

        async function retrieveLogs() {
            showStatus('Retrieving logs from Vast...', 'info');
            updateProgress(10, 'Fetching logs...');
            debugLog('Starting log retrieval');

            try {
                // Make actual API call to retrieve logs
                const response = await makeRequest('/retrieve_logs');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const logs = await response.json();
                debugLog(`Received ${Array.isArray(logs) ? logs.length : 'unknown'} logs from API`);
                
                // Handle error response
                if (logs.error_retrieving_logs) {
                    throw new Error(logs.error_retrieving_logs);
                }
                
                // Convert logs to flattened JSON format - one record per line
                let logText = '';
                if (Array.isArray(logs)) {
                    logText = logs.map(record => JSON.stringify(record)).join('\n');
                } else {
                    // If single log object, just stringify it
                    logText = JSON.stringify(logs);
                }
                
                document.getElementById('logInput').value = logText;
                
                updateLogCounter(logText);
                showStatus('Logs retrieved successfully!', 'success');
                updateProgress(0, 'Ready');
                debugLog(`Retrieved ${Array.isArray(logs) ? logs.length : 1} log entries`);
            } catch (error) {
                showStatus(`Error retrieving logs: ${error.message}`, 'error');
                updateProgress(0, 'Error');
                debugLog(`Log retrieval failed: ${error.message}`, 'ERROR');
            }
        }

        async function startAnalysis() {
            const logInput = document.getElementById('logInput').value.trim();
            if (!logInput) {
                showStatus('Please provide security logs before starting analysis.', 'error');
                return;
            }

            if (analysisInProgress) {
                showStatus('Analysis already in progress...', 'warning');
                return;
            }

            debugLog('Starting analysis workflow');
            analysisInProgress = true;
            document.getElementById('analyzeBtn').disabled = true;
            resetAgentStates();
            hideFindings();

            try {
                showStatus('Starting multi-agent analysis...', 'info');
                updateProgress(5, 'Initializing agents...');
                
                // Simulate the analysis workflow
                await simulateAnalysisWorkflow();

            } catch (error) {
                showStatus(`Analysis failed: ${error.message}`, 'error');
                updateAgentStatus('triage', 'error');
                showAgentOutput('triage', `Error: ${error.message}`);
                analysisInProgress = false;
                document.getElementById('analyzeBtn').disabled = false;
                debugLog(`Analysis failed: ${error.message}`, 'ERROR');
            }
        }

        async function simulateAnalysisWorkflow() {
            // Step 1: Triage Agent
            updateProgress(15, 'Running triage analysis...');
            updateAgentStatus('triage', 'active');
            showAgentSpinner('triage', true);
            document.getElementById('triageCard').classList.add('active');
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            updateAgentStatus('triage', 'complete');
            showAgentSpinner('triage', false);
            showAgentOutput('triage', `[${new Date().toLocaleTimeString()}] Triage analysis initiated
Parsing security logs...
Identified 2 potential security events
- High severity: Suspicious SSH connection attempt
- Medium severity: Failed authentication event
Priority threat detected: Unauthorized SSH access attempt from 192.168.1.100
Escalating to context research agent...`);
            
            document.getElementById('triageCard').classList.remove('active');
            
            // Step 2: Context Research Agent
            updateProgress(50, 'Researching historical context...');
            updateAgentStatus('context', 'active');
            showAgentSpinner('context', true);
            document.getElementById('contextCard').classList.add('active');
            
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            updateAgentStatus('context', 'complete');
            showAgentSpinner('context', false);
            showAgentOutput('context', `[${new Date().toLocaleTimeString()}] Context research initiated
Querying historical incident database...
Found 3 similar incidents in the past 30 days
- Pattern match: SSH brute force attempts from similar IP ranges
- Geographic correlation: Source IP traced to known threat actor region
- Timeline analysis: Recent uptick in similar activities
Threat actor profile: APT group with focus on SSH exploitation
Providing enriched context to senior analyst...`);
            
            document.getElementById('contextCard').classList.remove('active');
            
            // Step 3: Senior Analyst
            updateProgress(85, 'Performing deep analysis...');
            updateAgentStatus('analyst', 'active');
            showAgentSpinner('analyst', true);
            document.getElementById('analystCard').classList.add('active');
            
            await new Promise(resolve => setTimeout(resolve, 2500));
            
            updateAgentStatus('analyst', 'complete');
            showAgentSpinner('analyst', false);
            showAgentOutput('analyst', `[${new Date().toLocaleTimeString()}] Senior analyst assessment
Comprehensive threat analysis completed
Risk Assessment: HIGH
- Attack vector: SSH brute force with credential stuffing
- Business impact: Potential system compromise and data exfiltration
- Urgency: Immediate action required

Recommended Actions:
1. Block source IP 192.168.1.100 at firewall level
2. Reset credentials for 'admin' account
3. Enable MFA for SSH access
4. Monitor for lateral movement indicators
5. Initiate incident response protocol

Analysis complete. Generating final report...`);
            
            document.getElementById('analystCard').classList.remove('active');
            
            // Complete analysis
            updateProgress(100, 'Analysis complete!');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Show final results
            displayFinalResults({
                structured_findings: {
                    priority_threat: {
                        threat_type: 'SSH Brute Force Attack',
                        source_ip: '192.168.1.100',
                        priority: 'high',
                        brief_summary: 'Unauthorized SSH access attempt detected with credential stuffing patterns'
                    },
                    detailed_analysis: {
                        business_impact: 'High - Potential system compromise',
                        recommended_actions: [
                            'Block malicious IP',
                            'Reset compromised credentials',
                            'Enable MFA',
                            'Monitor for lateral movement',
                            'Initiate incident response'
                        ]
                    }
                },
                chroma_context: {
                    documents: ['incident_1', 'incident_2', 'incident_3']
                }
            });
            
            analysisInProgress = false;
            document.getElementById('analyzeBtn').disabled = false;
            updateProgress(0, 'Ready');
            showStatus('Multi-agent analysis completed successfully!', 'success');
        }

        function displayFinalResults(results) {
            debugLog('Displaying final analysis results');
            const panel = document.getElementById('findingsPanel');
            const content = document.getElementById('findingsContent');
            
            // Extract priority from structured findings
            let priority = 'medium';
            if (results.structured_findings && results.structured_findings.priority_threat) {
                const threatPriority = results.structured_findings.priority_threat.priority;
                if (threatPriority) {
                    priority = threatPriority.toLowerCase();
                }
            }
            
            // Set priority indicator
            const priorityElement = document.getElementById('priorityIndicator');
            priorityElement.textContent = priority.toUpperCase();
            priorityElement.className = `priority-indicator priority-${priority}`;
            
            // Create findings cards from structured data
            const findings = [];
            
            if (results.structured_findings.priority_threat) {
                const threat = results.structured_findings.priority_threat;
                findings.push({
                    title: '🚨 Priority Threat',
                    content: `${threat.threat_type || 'Unknown threat'} detected from ${threat.source_ip || 'unknown source'}. ${threat.brief_summary || 'No summary available.'}`
                });
                debugLog(`Priority threat identified: ${threat.threat_type} from ${threat.source_ip}`);
            }
            
            if (results.chroma_context && !results.chroma_context.error) {
                const contextCount = results.chroma_context.documents ? results.chroma_context.documents.length : 0;
                findings.push({
                    title: '📚 Historical Context',
                    content: `Found ${contextCount} related historical incidents to provide context for this analysis.`
                });
                debugLog(`Historical context found: ${contextCount} related incidents`);
            }
            
            if (results.structured_findings.detailed_analysis) {
                const analysis = results.structured_findings.detailed_analysis;
                const actionCount = analysis.recommended_actions ? analysis.recommended_actions.length : 0;
                findings.push({
                    title: '🎯 Analysis Complete',
                    content: `Deep analysis completed with ${actionCount} recommended actions. Business impact: ${analysis.business_impact || 'Under assessment'}.`
                });
                debugLog(`Detailed analysis completed: ${actionCount} recommendations`);
            }
            
            // Fallback if no structured findings
            if (findings.length === 0) {
                findings.push({
                    title: '✅ Analysis Complete',
                    content: 'Multi-agent analysis completed successfully. Check individual agent outputs above for detailed findings and recommendations.'
                });
            }
            
            content.innerHTML = findings.map(finding => `
                <div class="finding-card">
                    <h4>${finding.title}</h4>
                    <p>${finding.content}</p>
                </div>
            `).join('');
            
            panel.style.display = 'block';
            panel.scrollIntoView({ behavior: 'smooth' });
            debugLog('Final results panel displayed');
        }

        function showStatus(message, type) {
            // Create and show a toast notification
            const toastContainer = getOrCreateToastContainer();
            const toast = createToast(message, type);
            toastContainer.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
            
            // Log to debug console
            debugLog(`Status: ${message}`, type.toUpperCase());
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function getOrCreateToastContainer() {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 9999;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                `;
                document.body.appendChild(container);
            }
            return container;
        }
        
        function createToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            return toast;
        }

        function updateAgentStatus(agent, status) {
            const element = document.getElementById(`${agent}Status`);
            element.className = `status-badge status-${status}`;
            element.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            debugLog(`Agent ${agent} status updated to: ${status}`);
        }

        function showAgentOutput(agent, text) {
            document.getElementById(`${agent}Output`).textContent = text;
            debugLog(`Agent ${agent} output updated`);
        }

        function showAgentSpinner(agent, show) {
            const spinner = document.getElementById(`${agent}Spinner`);
            const output = document.getElementById(`${agent}Output`);
            
            if (show) {
                spinner.style.display = 'flex';
                output.style.opacity = '0.3';
            } else {
                spinner.style.display = 'none';
                output.style.opacity = '1';
            }
        }

        function updateProgress(percent, statusText = '') {
            document.getElementById('progressBar').style.width = `${percent}%`;
            const progressTextElement = document.getElementById('progressText');
            if (statusText) {
                progressTextElement.textContent = statusText;
            } else {
                progressTextElement.textContent = percent > 0 ? `${percent}%` : 'Ready';
            }
        }

        function resetAgentStates() {
            debugLog('Resetting all agent states');
            ['triage', 'context', 'analyst'].forEach(agent => {
                updateAgentStatus(agent, 'pending');
                showAgentSpinner(agent, false);
                document.getElementById(`${agent}Card`).classList.remove('active');
                const outputTexts = {
                    triage: 'Waiting for analysis to begin...',
                    context: 'Waiting for triage completion...',
                    analyst: 'Waiting for context research...'
                };
                showAgentOutput(agent, outputTexts[agent]);
            });
        }

        function hideFindings() {
            document.getElementById('findingsPanel').style.display = 'none';
        }

        function clearResults() {
            debugLog('Clearing all results and resetting dashboard');
            document.getElementById('logInput').value = '';
            document.getElementById('logCounter').textContent = '0 events';
            resetAgentStates();
            hideFindings();
            updateProgress(0, 'Ready');
            analysisInProgress = false;
            document.getElementById('analyzeBtn').disabled = false;
            
            // Clear network stats
            networkStats = { requests: 0, errors: 0, totalBytes: 0 };
            showStatus('Dashboard cleared and reset', 'info');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+Shift+D for debug mode
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                toggleDebugMode();
            }
            
            // Ctrl+Shift+C for clear
            if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                clearResults();
            }
            
            // Ctrl+Shift+A for analyze
            if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                e.preventDefault();
                if (!analysisInProgress) {
                    startAnalysis();
                }
            }
        });

        // Monitor textarea changes for log counter
        document.getElementById('logInput').addEventListener('input', function(e) {
            updateLogCounter(e.target.value);
        });

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            resetAgentStates();
            
            // Welcome message
            showStatus('Welcome to SOC Agent Dashboard! Retrieve logs or paste your own to begin analysis.', 'info');
            
            // Show keyboard shortcuts in console
            setTimeout(() => {
                console.log('💡 SOC Dashboard Shortcuts:');
                console.log('  • Ctrl+Shift+D → Toggle debug mode');
                console.log('  • Ctrl+Shift+A → Start analysis');
                console.log('  • Ctrl+Shift+C → Clear results');
                debugLog('Dashboard initialized successfully with keyboard shortcuts enabled');
            }, 2000);
        });
    </script>
</body>
</html>
